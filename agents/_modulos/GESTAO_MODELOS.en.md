# agents/_modulos/GESTAO_MODELOS.en.md — DOCUMENT TEMPLATE & VARIABLES MANAGEMENT
# Read alongside: agents/_base/AGENTS.md | agents/_base/MOCKS.md | agents/_modulos/WIZARD_PORTARIA.en.md | agents/_modulos/PAPEL_TIMBRADO.md
# AI: This is the English version for better technical comprehension. Always RESPOND in pt-BR.

---

## IDENTITY

This file specifies the Document Template Management and System Variables screens.
The Admin configures the "molds" that feed the Wizard. Never hardcode fields in the Wizard.
Every field in the Wizard exists because an Admin registered it here first.

---

## 1. CONCEPT: THE FORM FACTORY

The template administration flow has 3 steps:

```
[ 1. Basic Data ] → [ 2. .docx Upload + Tag Extraction ] → [ 3. Variable Configuration ]
```

The `.docx` template MUST follow the official city hall letterhead standard.
See `agents/_modulos/PAPEL_TIMBRADO.md` before creating or validating templates.

---

## 2. `ModeloVariavel` TYPE (MINIMUM CONTRACT)

This type is the bridge between the DOCX template and the Wizard. Define in `src/types/domain.ts`.

```typescript
export type TipoVariavel = 'texto' | 'numero' | 'data' | 'moeda' | 'cpf' | 'select'

export interface ModeloVariavel {
  tag:         string        // exact tag name in .docx, e.g. 'NOME_SERVIDOR'
  label:       string        // label shown in Wizard, e.g. 'Full Name'
  tipo:        TipoVariavel  // input type rendered in Wizard
  obrigatorio: boolean       // if true: red asterisk + Zod validation
  opcoes:      string[]      // only used when tipo === 'select'
  ordem:       number        // display order in the form (1, 2, 3...)
}

export interface Modelo {
  id:           string
  nome:         string              // e.g. 'Appointment Order'
  categoria:    string              // e.g. 'HR', 'Procurement', 'Cabinet'
  secretariaId: string | null       // null = global (all secretarias can see)
  docxUrl:      string              // .docx URL in Supabase Storage
  variaveis:    ModeloVariavel[]    // ordered list of user variables
  ativo:        boolean             // false = hidden in Wizard gallery
  createdAt:    string
  updatedAt:    string
}
```

---

## 3. TAG EXTRACTION RULE

```typescript
// Regex: finds everything between {{ and }}
const TAG_REGEX = /\{\{\s*([A-Z0-9_]+)\s*\}\}/g

// System variable prefixes (ignore — backend fills these automatically)
const SYS_PREFIXES = ['SYS_']

export function extrairTagsDocx(docxText: string): string[] {
  const matches = [...docxText.matchAll(TAG_REGEX)]
  const tags = matches.map(m => m[1].trim())
  const unique = [...new Set(tags)]                                  // remove duplicates
  return unique.filter(t => !SYS_PREFIXES.some(p => t.startsWith(p))) // remove SYS_*
}
```

**Frontend behavior after upload:**
1. Read `.docx` via `mammoth.js` (extract raw text)
2. Apply `extrairTagsDocx()` on the text
3. For each extracted tag, generate a configuration card in Step 3
4. Send the `.docx` via `POST /api/upload` — returns `{ docxUrl }`

---

## 4. SYSTEM VARIABLES (`/admin/variaveis` screen)

The Admin fills in fixed city hall data that rarely changes.
The Wizard NEVER shows these variables to the end user — the backend injects them silently.

### Required variables (must exist in the database before first use)

| Tag | Description | Example |
|---|---|---|
| `SYS_PREFEITO_NOME` | Mayor's full name | "João Silva" |
| `SYS_MUNICIPIO_NOME` | Municipality name | "Cataguases" |
| `SYS_ESTADO_SIGLA` | State abbreviation | "MG" |
| `SYS_CNPJ_PREFEITURA` | City Hall CNPJ | "00.000.000/0001-00" |
| `SYS_DATA_HOJE` | Today's date (formatted) | Auto-generated by backend |
| `SYS_NUMERO_PORTARIA` | Official document number | Atomically generated by backend |
| `SYS_ASSINANTE_NOME` | Signer's name | Filled during signing flow |
| `SYS_ASSINANTE_CARGO` | Signer's title | Filled during signing flow |
| `SYS_DATA_ASSINATURA` | Signing timestamp | Filled during signing flow |
| `SYS_CHANCELA_RODAPE` | Footer seal with hash | Filled during signing flow |

---

## 5. BACKEND ENDPOINTS (Cycle 3)

```
GET    /api/admin/modelos          — list templates (ABAC: gerenciar Modelo)
POST   /api/admin/modelos          — create template
GET    /api/admin/modelos/[id]     — get single template with variaveis[]
PATCH  /api/admin/modelos/[id]     — update template
DELETE /api/admin/modelos/[id]     — delete (blocked if portarias exist for this model)
GET    /api/admin/variaveis        — list editable system variables
PATCH  /api/admin/variaveis/[id]   — update variable value (ADMIN_GERAL only)
POST   /api/upload                 — upload .docx to Supabase Storage (returns docxUrl)
```

**ABAC Rules:**
- `ADMIN_GERAL` can create global templates (`secretariaId: null`) and edit any template
- `SECRETARIO` can only create/edit templates for their own secretaria
- Only `ADMIN_GERAL` can delete templates and edit system variables

---

## 6. FULL CREATE PAYLOAD

```json
{
  "nome": "Appointment Order",
  "categoria": "HR",
  "secretariaId": null,
  "docxUrl": "https://storage.supabase.co/.../appointment-order.docx",
  "ativo": true,
  "variaveis": [
    { "tag": "NOME_SERVIDOR",  "label": "Employee Full Name", "tipo": "texto",  "obrigatorio": true,  "opcoes": [], "ordem": 1 },
    { "tag": "CPF_SERVIDOR",   "label": "Employee CPF",       "tipo": "cpf",    "obrigatorio": true,  "opcoes": [], "ordem": 2 },
    { "tag": "CARGO",          "label": "Position",           "tipo": "select", "obrigatorio": true,  "opcoes": ["Permanent", "Commissioned", "Intern"], "ordem": 3 },
    { "tag": "SALARIO",        "label": "Salary",             "tipo": "moeda",  "obrigatorio": true,  "opcoes": [], "ordem": 4 },
    { "tag": "DATA_INICIO",    "label": "Start Date",         "tipo": "data",   "obrigatorio": true,  "opcoes": [], "ordem": 5 }
  ]
}
```

---

## 7. COMPLETION CHECKLIST (Cycle 3)

- [ ] `ModeloVariavel` and `Modelo` interfaces defined in `src/types/domain.ts`
- [ ] `VariavelSistema` interface defined in `src/types/domain.ts`
- [ ] `extrairTagsDocx()` working with correct regex and `SYS_*` filter
- [ ] Step 3 only appears after successful `.docx` upload
- [ ] `GET /api/admin/modelos` returns templates with `variaveis[]`
- [ ] `POST /api/admin/modelos` validates payload with Zod
- [ ] `DELETE /api/admin/modelos/[id]` blocks if portarias are linked
- [ ] `SYS_*` variables do not appear in the Wizard form
- [ ] `GET /api/admin/variaveis` returns only editable variables
- [ ] `.docx` template follows letterhead standard (`PAPEL_TIMBRADO.md`)
