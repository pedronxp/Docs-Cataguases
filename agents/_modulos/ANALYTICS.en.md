# agents/_modulos/ANALYTICS.en.md â€” ANALYTICS DASHBOARD
# Read alongside: agents/_base/AGENTS.md | agents/_base/MOCKS.md
# AI: This is the English version for better technical comprehension. Always RESPOND in pt-BR.

---

## IDENTITY

This file specifies the Analytics Screen (`/_sistema/admin/analytics`).
High-level administrative dashboard for Top Management and Mayor.
Displays metrics and organic document volume generated by the City Hall.

---

## 1. ACCESS CONTROL (ABAC)

**Required permission:** `ability.can('gerenciar', 'all')`

**Who accesses:**
- `ADMIN_GERAL`
- `PREFEITO`

**No access:**
- `SECRETARIO`, `OPERADOR`, `GESTOR_SETOR`

If user without permission tries to access, redirect to `/403` or Dashboard.

---

## 2. FILTERING FEATURES (HEADER)

Two selectors at page top:

### 2.1. "All Secretarias" Filter

- Populates dynamically via `listarSecretarias()`
- Allows viewing:
  - **Macro:** consolidated numbers from entire city hall
  - **Specific:** restrict to one secretaria

### 2.2. "All Setores" Filter

- **Initial state:** `disabled`
- **Enabled when:** user selects a specific Secretaria in filter 1
- Refines visualization to a sub-sector of selected secretaria

### Dynamic Behavior (React Effect)

Whenever a filter changes:
1. Triggers new query: `buscarDadosAnalytics({ secretariaId, setorId })`
2. Shows Skeleton in cards during loading
3. Updates KPIs and charts

---

## 3. KEY PERFORMANCE INDICATORS (KPI CARDS)

4-card grid:

### 3.1. Total Produced

- **Metric:** Total volume of portarias/documents drafted (all statuses)
- **Subtext:** Growth percentage vs. previous month (e.g., `+12.5%`)
- **Icon:** `FileText`

### 3.2. Publication Rate

- **Metric:** Percentage of portarias that reached `PUBLICADA` status
- **Formula:** `(PUBLICADAS / TOTAL) * 100`
- **Purpose:** Measure funnel efficiency
- **Icon:** `TrendingUp`

### 3.3. Official Archive

- **Metric:** Total documents with `status = 'PUBLICADA'`
- **Equivalence:** Signed and immutably indexed documents
- **Icon:** `Archive`

### 3.4. Most Active Agency (Highlight)

- **Style:** Visually distinct card (indigo-Gov colors)
- **Metric:** Secretaria with highest recent activity volume
- **Displays:** Acronym/Name + quantity
- **Icon:** `Award`

---

## 4. VISUAL CHARTS (RECHARTS)

Library: `recharts`

### 4.1. Historical Evolution (AreaChart)

**Configuration:**
- **Type:** Fluid area with gov-blue gradient
- **X-Axis:** Timeline of last 6 months (Jan, Feb, Mar...)
- **Y-Axis:** Document volume per period
- **Interactivity:** Tooltip with exact data on hover

### 4.2. Distribution by Status (PieChart Donut)

**Configuration:**
- **Type:** Centered hollow pizza (Donut)
- **innerRadius:** `60`
- **Slices by color:**
  - ðŸŸ© **Green (Emerald #10b981):** `PUBLICADA`
  - ðŸŸ¦ **Blue (#3b82f6):** `PROCESSANDO`
  - â¬œ **Slate Gray (#64748b):** `RASCUNHO`
  - ðŸŸ§ **Amber Orange (#f59e0b):** `AGUARDANDO_ASSINATURA`
- **Legend:** Below chart, mapping color + text + count

---

## 5. BACKEND ENDPOINT (Cycle 3)

```
GET /api/analytics
  Query:   secretariaId?, setorId?
  Auth:    Requires gerenciar:all (ADMIN_GERAL, PREFEITO)
  Returns: ChartData (KPIs + evolucaoMensal + distribuicaoStatus + secretariasTop)
```

---

## 6. COLOR PALETTE (GOV.BR)

| Element | Hex | Usage |
|---|---|---|
| Gov Blue | `#1351B4` | Area chart (primary) |
| Emerald | `#10b981` | PUBLICADA status |
| Blue | `#3b82f6` | PROCESSANDO status |
| Slate | `#64748b` | RASCUNHO status |
| Amber | `#f59e0b` | AGUARDANDO_ASSINATURA status |
| Indigo | `#6366f1` | "Most Active Agency" card |

---

## 7. ACCEPTANCE CRITERIA

- [ ] Screen accessible only to `ADMIN_GERAL` and `PREFEITO`
- [ ] 403 redirect for users without permission
- [ ] "Secretarias" filter populates dynamically
- [ ] "Setores" filter disabled until secretaria selected
- [ ] Filter change triggers new query with skeleton
- [ ] 4 KPI cards displaying correct metrics
- [ ] "Most Active Agency" card visually highlighted
- [ ] Area chart with gov-blue gradient working
- [ ] Donut chart with correct colors per status
- [ ] Chart legend displayed below
- [ ] Interactive tooltip on charts
- [ ] Responsive layout (mobile, tablet, desktop)
- [ ] Skeleton shown during loading

---

## 8. COMPLETION CHECKLIST (Cycle 1)

- [ ] `src/services/analytics.service.ts` created with `buscarDadosAnalytics`
- [ ] TypeScript interfaces created: `KpiMetrics`, `HistoricoItem`, `ChartData`, `AnalyticsFiltro`
- [ ] `src/routes/_sistema/admin/analytics.tsx` created
- [ ] `recharts` dependency installed
- [ ] 4 KPI cards implemented with Lucide icons
- [ ] `AreaChart` (Monthly Evolution) implemented
- [ ] `PieChart` Donut (Status Distribution) implemented
- [ ] Secretaria and Setor filters working with React state
- [ ] Conditional enable logic for Setor filter implemented
- [ ] ABAC control (`ability.can('gerenciar', 'all')`) applied
- [ ] "Analytics" item added to sidebar (Admin section)
- [ ] Loading skeleton implemented
- [ ] Responsive layout tested (mobile, tablet, desktop)
- [ ] Gov.br colors applied correctly
