generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// O modelo User foi movido para baixo para manter as relações próximas

model LivrosNumeracao {
  id               String   @id @default(cuid())
  nome             String   @unique @default("Numeração Geral Cataguases")
  formato_base     String   @default("PORT-{N}/CATAGUASES")
  proximo_numero   Int      @default(1)
  numero_inicial   Int      @default(1)
  tipos_suportados Json     @default("{\"PORTARIA\":1}")
  logs             Json     @default("[]")
  ativo            Boolean  @default(true)
  criado_em        DateTime @default(now())
  atualizado_em    DateTime @updatedAt
}

model Portaria {
  id              String   @id @default(cuid())
  titulo          String
  descricao       String?
  numeroOficial   String?
  status          String   @default("RASCUNHO") // RASCUNHO, PROCESSANDO, ASSINADO, PUBLICADO, ARQUIVADO
  criadoPorId     String
  secretariaId    String
  setorId         String?
  modeloId        String
  modelo          ModeloDocumento @relation(fields: [modeloId], references: [id])
  criadoPor       User            @relation("CriadoPor", fields: [criadoPorId], references: [id])
  secretaria      Secretaria      @relation(fields: [secretariaId], references: [id])
  setor           Setor?          @relation(fields: [setorId], references: [id])
  pdfUrl          String?
  docxRascunhoUrl String?
  hashIntegridade String?  @unique // SHA-256 do conteúdo
  assinadoEm      DateTime?
  assinadoPorId   String?
  dataPublicacao  DateTime?
  formData        Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  atividades      FeedAtividade[]

  // Controle de Revisão
  revisorAtualId           String?
  revisorAtual             User?           @relation("RevisorAtual", fields: [revisorAtualId], references: [id])
  revisoesCount            Int             @default(0)
  
  // Controle de Assinatura Avançado
  assinaturaStatus         String          @default("NAO_ASSINADA") // NAO_ASSINADA, ASSINADA_DIGITAL, ASSINADA_MANUAL, DISPENSADA_COM_JUSTIFICATIVA
  assinaturaJustificativa  String?         @db.Text
  assinaturaComprovanteUrl String?

  jornalQueue              JornalQueue?
}

// Atualizar User para ter a relação inversa
model User {
  id              String   @id @default(cuid())
  name            String
  username        String   @unique
  email           String   @unique
  password        String
  cpf             String?  @unique
  role            String   @default("OPERADOR")
  ativo           Boolean  @default(true)
  permissoesExtra String[] @default([])
  secretariaId    String?
  setorId         String?
  secretaria      Secretaria?     @relation(fields: [secretariaId], references: [id])
  setor           Setor?          @relation(fields: [setorId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  portarias       Portaria[] @relation("CriadoPor")
  portariasRevisadas Portaria[] @relation("RevisorAtual")
  atividades      FeedAtividade[]
}

model FeedAtividade {
  id           String   @id @default(cuid())
  tipoEvento   String
  mensagem     String   @db.Text
  portariaId   String
  autorId      String
  secretariaId String
  setorId      String?
  portaria     Portaria @relation(fields: [portariaId], references: [id])
  autor        User     @relation(fields: [autorId], references: [id])
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now())
}

model ModeloDocumento {
  id              String           @id @default(cuid())
  nome            String
  descricao       String
  secretariaId    String?
  docxTemplateUrl String
  conteudoHtml    String           @default("") @db.Text
  ativo           Boolean          @default(true)
  variaveis       ModeloVariavel[]
  portarias       Portaria[]
}

model ModeloVariavel {
  id          String          @id @default(cuid())
  modeloId    String
  modelo      ModeloDocumento @relation(fields: [modeloId], references: [id])
  chave       String
  label       String
  tipo        String          @default("texto")
  opcoes      String[]        @default([])
  obrigatorio Boolean         @default(true)
  ordem       Int             @default(0)
}

model VariavelSistema {
  id                       String  @id @default(cuid())
  chave                    String  @unique
  valor                    String
  descricao                String
  resolvidaAutomaticamente Boolean @default(false)
}

model Secretaria {
  id      String   @id @default(cuid())
  nome    String
  sigla   String   @unique
  cor     String   @default("#6366f1")
  setores Setor[]
  usuarios User[]
  portarias Portaria[]
  ativo   Boolean  @default(true)
}

model Setor {
  id           String     @id @default(cuid())
  nome         String
  sigla        String
  secretariaId String
  secretaria   Secretaria @relation(fields: [secretariaId], references: [id])
  usuarios     User[]
  portarias    Portaria[]
  ativo        Boolean    @default(true)
  
  @@unique([secretariaId, sigla])
}

model JornalQueue {
  id              String   @id @default(cuid())
  portariaId      String   @unique // FK para Portaria
  numeroSugerido  String?  // Ex: "007/2026" vindo do LivroNumeracao
  numeroFinal     String?
  status          String   @default("PENDENTE") // PENDENTE, CONCLUIDA
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  portaria        Portaria @relation(fields: [portariaId], references: [id], onDelete: Cascade)
}
